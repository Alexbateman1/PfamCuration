#! /usr/bin/perl
# This curation script tries toidentify if any PDB structures match the family.
# Then the script will try to pfetch the PDB entry and see if it has any
# associated papers. It will then add any papers it finds to your DESC file.
# To do
# 
# 
print STDERR "Running $0\n";
if (-e ".add_pdb_ref"){
    print STDERR "add_pdb_ref.pl has already been run in this directory.\n";
    exit;
}
system("touch .add_pdb_ref");
if (! -e "pdb.xml"){
    print STDERR "Running pdb search at HMMER webserver\n";
#    system("curl -L -H 'Expect:' -H 'Accept:text/xml' -F seqdb=pdb -F seq='<SEED' https://www.ebi.ac.uk/Tools/hmmer/search/hmmsearch > pdb.xml");
#    system("curl -L -H 'Expect:' -H 'Accept:text/xml' -F seqdb=pdb -F seq='<SEED' https://www.ebi.ac.uk/Tools/hmmer/search/hmmsearch > pdb.xml");
#    system("curl -L -H 'Expect:' -H 'Accept:text/xml' -F seqdb=pdb -F seq="@SEED" https://www.ebi.ac.uk/Tools/hmmer/search/hmmsearch > pdb.xml");
#system("curl -L -H 'Expect:' -H 'Accept:text/xml' -F seqdb=pdb -F 'seq=\@SEED' https://www.ebi.ac.uk/Tools/hmmer/search/hmmsearch > pdb.xml");
#system("curl -v -L -H 'Expect:' -H 'Accept:text/xml' -F seqdb=pdb -F seq='<SEED' https://www.ebi.ac.uk/Tools/hmmer/search/hmmsearch > pdb.xml");
# First, submit the job and get a UUID
my $response = `curl -s -X POST -H 'Content-Type: application/json' -d '{"seqdb":"pdb","seq":"'"\$(cat SEED | perl -pe 's/\\n/\\\\n/g')"'"}' https://www.ebi.ac.uk/Tools/hmmer/api/v1/search/hmmsearch`;
}
my %pubmed; # Global variable to store pmids that are found.
# Now parse pdb.xml
my %pdbid;
open (XML, "pdb.xml") or die "Cannot open file pdb.xml";
while(<XML>){
#  <hits name="2lvr_A" acc="2lvr_A" arch="PF13894.6 PF00096.26 PF00096.26" archScore="4" archindex="170049003002308 9606" bias="3.9" desc="Zinc finger and BTB domain-containing protein 17" evalue="0.24" extlink="https://www.ebi.ac.uk/pdbe/entry/pdb/2lvr_A" flags="2" kg="Eukaryota" ndom="2" nincluded="0" niseqs="13" nregions="1" nreported="2" ph="Chordata" pvalue="-14.4239593741603" score="15.7" sindex="225009026" species="Homo sapiens" taxid="9606" taxlink="http://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?mode=Info&amp;id=">
    if (/\<hits name=\"(\S{4})_\S\".*evalue=\"(\S+)\".*score=\"(\S+)\"/){
	my $pdbid=$1;
	my $evalue=$2;
	my $bits=$3;
	if ($bits>25){
	    $pdbid{$pdbid}=1;
	}
    }
}
close XML;
# Now loop over pdb identifiers and try to add papers.
my $total=0;
foreach my $id (sort keys %pdbid){
    my $result=add_paper($id);
    $total=$total+$result;
    if ($total>4){
	print STDERR "Found enough structure papers\n";
	exit;
    }
}
sub add_paper {
    my $pdb=shift @_;
    my $result=0;
    print STDERR "Attempting to add paper for $pdb\n";
    open (PDB, "curl \"http://files.rcsb.org/view/$pdb.pdb\" |") or warn "Cannot pfetch --pdb $pdb";
    while(<PDB>){
	if (/JRNL\s+PMID\s+(\d+)/){
	    my $pmid=$1;
	    
	    if ($pubmed{$pmid}){
		print STDERR "$pmid inserted already. Skipping.\n";
		return 0;
	    } else {
		$pubmed{$pmid}=1;
		my $comment="RC   Paper describing PDB structure $pdb\n";
		open (DESC, ">> DESC") or die "Cannot append to DESC file";
		print DESC $comment;
		close DESC;
		# Try and add to DESC.
		print STDERR "Adding $pmid to DESC\n";
		system ("add_ref.pl $pmid");
		system("touch .3d");
		$result=1;
	    }
	}
    }
    close PDB;
    return $result;
}
